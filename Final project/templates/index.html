<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å·¥ç¨‹è¨­è¨ˆé€å­—ç¨¿åˆ†æ</title>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      margin: 0;
      padding: 30px;
      background: linear-gradient(135deg, #b2ebf2, #f8bbd0);
      font-size: 35px;
    }
    h2, h3, h4 { text-align: center; color: #2c3e50; }
    form, #status, #ai-feedback-container, #student-feedback-container {
      background: #fff; border: 1px solid #ddd; padding: 20px;
      border-radius: 10px; margin: 30px auto; max-width: 1500px;
    }
    input[type="file"], button {
      width: 100%; padding: 12px; font-size: 30px; border-radius: 6px;
    }
    button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #45a049; }
    img { display: block; max-width: 90%; margin: 20px auto; border-radius: 4px; }
    #ai-feedback-text, .student-sequence, .student-analysis { white-space: pre-wrap; line-height: 1.6em; font-size: 30px; }
  </style>
</head>
<body>

<h2>ğŸ§ª å·¥ç¨‹è¨­è¨ˆé€å­—ç¨¿åˆ†æç³»çµ±</h2>

<form id="upload-form" enctype="multipart/form-data">
  <label>ğŸ“‚ é¸æ“‡é€å­—ç¨¿ CSV æª”æ¡ˆ</label>
  <input type="file" id="file" name="file" accept=".csv" required>
  <button type="submit">ğŸš€ ä¸Šå‚³ä¸¦åˆ†æ</button>
</form>

<div id="status"></div>

<h3>ğŸ“ˆ æƒ…ç·’è¶¨å‹¢åœ–</h3>
<img id="moodtrend" src="" alt="å°šæœªç”¢ç”Ÿæƒ…ç·’åœ–">

<h3>ğŸ› ï¸ å·¥ç¨‹æ§‹é¢æ¯”ä¾‹åœ–</h3>
<img id="aspect_bar" src="" alt="å°šæœªç”¢ç”Ÿæ§‹é¢åœ–">

<div id="ai-feedback-container">
  <h3>ğŸ’¡ AI çµ¦å…¨ç­çš„å­¸ç¿’å»ºè­°</h3>
  <p id="ai-feedback-text"></p>
</div>

<div id="student-feedback-container">
  <h3>ğŸ“‹ æ¯ä½å­¸ç”Ÿçš„æ§‹é¢é †åº</h3>
  <div id="student-sequence-list"></div>
</div>

<div id="student-analysis-container">
  <h3>ğŸ§  å€‹åˆ¥å­¸ç”Ÿå»ºè­°åˆ†æ</h3>
  <div id="student-analysis-list"></div>
</div>

<div style="text-align:center">
  <button onclick="downloadPDF()">ğŸ“„ ä¸‹è¼‰ PDF å ±è¡¨</button>
</div>

<script>
const socket = io();
let latestFeedback = "";
let latestSequence = {};

socket.on("status", function (data) {
  document.getElementById("status").innerText += data.message + "\n";
});

socket.on("result", function (data) {
  if (data.moodtrend_img) document.getElementById("moodtrend").src = data.moodtrend_img;
  if (data.aspect_bar_img) document.getElementById("aspect_bar").src = data.aspect_bar_img;
  if (data.ai_feedback) {
    document.getElementById("ai-feedback-text").innerText = data.ai_feedback;
    document.getElementById("ai-feedback-container").style.display = "block";
    latestFeedback = data.ai_feedback;
  }

  if (data.aspect_sequence_json) {
    fetch(data.aspect_sequence_json).then(res => res.json()).then(json => {
      latestSequence = json;
      let html = "";
      for (const student in json) {
        if (student.includes("è¨ªå•è€…") || student.includes("è¨ªè«‡è€…")) continue;
        html += `<div class='student-sequence'><strong>${student}</strong>ï¼š${json[student].join(' âœ ')}</div><hr>`;
      }
      document.getElementById("student-sequence-list").innerHTML = html;
      document.getElementById("student-feedback-container").style.display = "block";

      // âœ… å›å‚³åœ–è¡¨è·¯å¾‘èˆ‡å»ºè­°å…§å®¹çµ¦å¾Œç«¯
      fetch("/set_feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ai_feedback: latestFeedback,
          student_sequences: latestSequence,
          moodtrend_img: data.moodtrend_img,
          aspect_bar_img: data.aspect_bar_img
        })
      }).then(() => {
        
        // âœ… é¡å¤–å–å¾—æ¯ä½å­¸ç”Ÿåˆ†æå»ºè­°ä¸¦é¡¯ç¤º
        fetch("/student_feedbacks")
          .then(res => res.json())
          .then(studentAdvice => {
            let detail = "";
            for (const student in studentAdvice) {
              if (student.includes("è¨ªå•è€…") || student.includes("è¨ªè«‡è€…")) continue;
              detail += `<div><strong>${student}</strong><p>${studentAdvice[student]}</p></div><hr>`;
            }
            document.getElementById("student-analysis-list").innerHTML = detail;
          });
      });
    });
  }
});

function downloadPDF() {
  window.open("/generate_pdf", "_blank");
}

document.getElementById("upload-form").addEventListener("submit", function (e) {
  e.preventDefault();
  const formData = new FormData();
  const fileInput = document.getElementById("file");
  formData.append("file", fileInput.files[0]);
  fetch("/upload", { method: "POST", body: formData })
    .then(() => { document.getElementById("status").innerText = "âœ… æª”æ¡ˆå·²ä¸Šå‚³ä¸¦é–‹å§‹åˆ†æ...\n"; });
});
</script>
</body>
</html>
